name: 'Plan'

on:
  # pull_request:
  #   types: [opened, synchronize, reopened]
  workflow_run:
    workflows: [Validate]
    types: [completed]
    branches-ignore: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  check-pr:
    name: 'Check for Pull Request to Main'
    runs-on: ubuntu-latest
    environment: test
    if: github.event.workflow_run.conclusion == 'success'
    outputs:
      has-pr-to-main: ${{ steps.check.outputs.has-pr-to-main }}
      pr-number: ${{ steps.check.outputs.pr-number }}
    
    steps:
    - name: Check for Pull Request targeting main
      id: check
      run: |
        # Get pull requests for the head branch targeting main
        PR_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&head=${{ github.repository_owner }}:${{ github.event.workflow_run.head_branch }}&base=main")
        
        PR_COUNT=$(echo "$PR_DATA" | jq length)
        
        if [ "$PR_COUNT" -gt 0 ]; then
          PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number')
          echo "has-pr-to-main=true" >> $GITHUB_OUTPUT
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "✅ Found pull request #$PR_NUMBER for branch ${{ github.event.workflow_run.head_branch }} targeting main"
        else
          echo "has-pr-to-main=false" >> $GITHUB_OUTPUT
          echo "❌ No pull request found for branch ${{ github.event.workflow_run.head_branch }} targeting main"
          echo "Plan workflow will not run - PR to main branch required"
        fi

  build:
    name: 'Create a file'
    runs-on: ubuntu-latest
    environment: test
    needs: check-pr
    if: needs.check-pr.outputs.has-pr-to-main == 'true'
    outputs:
      run-id: ${{ github.run_id }}

    steps:
    - name: Checkout
      uses: actions/checkout@v5
      with:
        ref: ${{ github.event.workflow_run.head_sha }}

    - name: Create a file
      run: 'echo "This is a test file from runner_id: ${{ github.run_id }}" > testfile.txt'

    - name: Upload Test File Artifact
      uses: actions/upload-artifact@v4
      with:
        name: testfile-${{ needs.check-pr.outputs.pr-number }}
        path: testfile.txt
